syntax = "proto3";

package api.voiceagent;

import "google/api/annotations.proto";
import "validate/validate.proto";
import "google/protobuf/empty.proto";
import "voiceagent/conversation.proto";

import "voiceagent/transcript.proto";

option go_package = "store/api/voiceagent;voiceagent";

// LiveKitService 提供了与 LiveKit 基础基础设施交互的接口。
service LiveKitService {
  // CreateConversation: 启动一个实时交互会话。基础功能。
  rpc CreateConversation(CreateConversationRequest) returns (Conversation) {
    option (google.api.http) = {
      post: "/api/va/conversations"
      body: "*"
    };
  }

  // GetConversation: 获取会话详情。
  rpc GetConversation(GetConversationRequest) returns (Conversation) {
    option (google.api.http) = {
      get: "/api/va/conversations/{id}"
    };
  }

  // ListConversations: 分页列出通话记录。
  rpc ListConversations(ListConversationsRequest) returns (ConversationList) {
    option (google.api.http) = {
      get: "/api/va/conversations"
    };
  }

  // UpdateConversation: 更新会话状态。
  rpc UpdateConversation(UpdateConversationRequest) returns (Conversation) {
    option (google.api.http) = {
      patch: "/api/va/conversations/{id}"
      body: "*"
    };
  }

  // StopConversation: 结束会话。
  rpc StopConversation(StopConversationRequest) returns (Conversation) {
    option (google.api.http) = {
      post: "/api/va/conversations/{id}/stop"
      body: "*"
    };
  }

  // AddTranscriptEntry: 记录一条对话消息。
  rpc AddTranscriptEntry(AddTranscriptEntryRequest) returns (TranscriptEntry) {
    option (google.api.http) = {
      post: "/api/va/transcripts"
      body: "*"
    };
  }

  // ListTranscriptEntries: 获取某个会话的所有聊天记录。
  rpc ListTranscriptEntries(ListTranscriptEntriesRequest) returns (TranscriptEntryList) {
    option (google.api.http) = {
      get: "/api/va/conversations/{conversationId}/transcripts"
    };
  }

  // SummarizeConversations: 触发会话总结任务。通常由 Cron Job 调用。
  rpc SummarizeConversations(google.protobuf.Empty) returns (google.protobuf.Empty) {
  }

}

message CreateConversationRequest {
  string agentId = 1 [(validate.rules).string.min_len = 1];
}

message StopConversationRequest {
  string id = 1;
}

message UpdateConversationRequest {
  string id = 1;
  string action = 4;
}

message GetConversationRequest {
  string id = 1;
}

message ListConversationsRequest {
  int64 page = 1;
  int64 size = 2;
}

message ConversationList {
  repeated Conversation list = 1;
  int64 total = 2;
}

message ListTranscriptEntriesRequest {
  string conversationId = 1;
  int64 page = 2;
  int64 size = 3;
}

message TranscriptEntryList {
  repeated TranscriptEntry list = 1;
  int64 total = 2;
}

message AddTranscriptEntryRequest {
  string conversationId = 1; // Optional, try to resolve from roomName
  string userId = 2; // Optional
  string role = 3; // "user" or "agent"
  string content = 4;
  string roomName = 5; // To look up conversation if ID missing
  string audioUrl = 6; // Optional
}

